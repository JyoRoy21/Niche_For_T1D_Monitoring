---
title: "Figure1"
author: "Jyotirmoy Roy"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Import 

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r Preprocessing}

pacman::p_load(tidyverse, plyr, magrittr, stats, dplyr, limma, RColorBrewer, gplots, 
               glmnet, biomaRt, colorspace, ggplot2, fmsb, car, mixOmics, DESeq2, 
               apeglm, boot, caret, ggvenn, grid, devtools, reshape2, gridExtra, 
               factoextra, edgeR, cowplot, pheatmap, coefplot, randomForest, ROCR, 
               genefilter, Hmisc, rdist, factoextra, ggforce, ggpubr, matrixStats, 
               GSEAmining, ggrepel, progress, mnormt, psych, igraph, dnapath, 
               reactome.db, GSVA, msigdbr, gglasso, MatrixGenerics, VennDiagram, 
               mikropml, glmnet, scales, stats, caret, nnet, pROC)

library(dplyr)
# MSIGDBR Pathways ----
# Needs msigdbr package: https://cran.r-project.org/web/packages/msigdbr/vignettes/msigdbr-intro.html
msigdbr_collections() # Take a look at all the pathway groups in the msigdbr database
sets_hallmark <- msigdbr(species="Mus musculus", category="H") # Large df w/ categories
pwl_hallmark <- split(sets_hallmark$gene_symbol, # Genes to split into pathways, by ensembl
                      sets_hallmark$gs_name) # Pathway names
sets_reactome <- msigdbr(species="Mus musculus", subcategory="CP:REACTOME") # Large df w/ categories
pwl_reactome <- split(sets_reactome$gene_symbol, # Genes to split into pathways, by ensembl
                      sets_reactome$gs_name) # Pathway names
kegg_gene_sets <- msigdbr(species="Mus musculus", subcategory="CP:KEGG") # Large df w/ categories
pwl_kegg <- split(kegg_gene_sets$gene_symbol, # Genes to split into pathways, by ensembl
                  kegg_gene_sets$gs_name) # Pathway names
biocarta_gene_sets <- msigdbr(species="Mus musculus", subcategory="CP:BIOCARTA") # Large df w/ categories
pwl_biocarta <- split(biocarta_gene_sets$gene_symbol, # Genes to split into pathways, by ensembl
                      biocarta_gene_sets$gs_name) # Pathway names
pwl_msigdbr <- c(pwl_hallmark, pwl_reactome, pwl_kegg, pwl_biocarta) # Compile them all
length(pwl_msigdbr)


getwd()

#Metadata Importing
meta_batch1 <- read.table("/Users/jyotirmoyroy/Desktop/Immunometabolism T1D Paper/Data/Sequencing/Pathway Analysis/metadata_Jessexperimental_PathwayAnalysis.csv", sep=",", header=T) # Metadata file
meta_batch2 <- read.table("/Users/jyotirmoyroy/Desktop/Immunometabolism T1D Paper/Data/Sequencing/Pathway Analysis/metadata_Jessvalidation_PathwayAnalysis.csv", sep=",", header=T) # Metadata file
meta_batch3 <- read.table("/Users/jyotirmoyroy/Desktop/Immunometabolism T1D Paper/Data/Sequencing/Pathway Analysis/metadata_MetabolomicsCohort_PathwayAnalysis.csv", sep=",", header=T) # Metadata file
meta_batch1 <- as.data.frame(meta_batch1)
meta_batch2 <- as.data.frame(meta_batch2)
meta_batch3 <- as.data.frame(meta_batch3)

# Merge metadata by columns (i.e., add samples from Batch 2 to Batch 1)
meta_combined <- rbind(meta_batch1, meta_batch2,meta_batch3)

# Preview the combined metadata
head(meta_combined)


#Counts Data Importing
counts_batch1 <- as.data.frame(read.table("/Users/jyotirmoyroy/Desktop/Immunometabolism T1D Paper/Data/Sequencing/Pathway Analysis/gene_expected_count.annot_Jessexperimental_PathwayAnalysis.csv", sep=",", header=T,check.names = FALSE)) # Raw counts file
counts_batch1 <- na.omit(counts_batch1)

counts_batch2 <- as.data.frame(read.table("/Users/jyotirmoyroy/Desktop/Immunometabolism T1D Paper/Data/Sequencing/Pathway Analysis/gene_expected_count.annot_Jessvalidation_PathwayAnalysis.csv", sep=",", header=T,check.names = FALSE)) # Raw counts file
counts_batch2 <- na.omit(counts_batch2)

counts_batch3 <- as.data.frame(read.table("/Users/jyotirmoyroy/Desktop/Immunometabolism T1D Paper/Data/Sequencing/Pathway Analysis/gene_expected_count.annot_MetabolomicsCohort_Week6.csv", sep=",", header=T,check.names = FALSE)) # Raw counts file
counts_batch3 <- na.omit(counts_batch3)


#Remove duplicate names
counts_batch1 <- counts_batch1[!duplicated(counts_batch1[, 1]), ]
genes <- counts_batch1[, 1]
rownames(counts_batch1) <- genes
counts_batch1 <- counts_batch1[, -1]

counts_batch2 <- counts_batch2[!duplicated(counts_batch2[, 1]), ]
genes <- counts_batch2[, 1]
rownames(counts_batch2) <- genes
counts_batch2 <- counts_batch2[, -1]

counts_batch3 <- counts_batch3[!duplicated(counts_batch3[, 1]), ]
genes <- counts_batch3[, 1]
rownames(counts_batch3) <- genes
counts_batch3 <- counts_batch3[, -1]

#Combine data
# Merge counts_batch1 and counts_batch2
combined_counts <- merge(counts_batch1, counts_batch2, by = "row.names", all = TRUE)
# Merge the result with counts_batch3
combined_counts <- merge(combined_counts, counts_batch3, by.x = "Row.names", by.y = "row.names", all = TRUE)

# Set rownames back to genes
rownames(combined_counts) <- combined_counts$Row.names
combined_counts <- combined_counts[, -1]

# Preview the combined dataset
head(combined_counts)

```

## PCA Analysis
```{r PCA}
meta_combined_time<-meta_combined
meta_combined_time$Group <- paste0(meta_combined_time$Group, "_", meta_combined$Time)



case1_f1 <- flexiDEG.function1(combined_counts, meta_combined_time, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = T, quality = T, variance = T,use_pseudobulk = F) # Select filters: 2, 0, 20



#### Start Analysis ####

case1_f2 <- flexiDEG.function2(case1_f1, meta_combined_time) # Run Function 2

# Reset "Non-Progressor" group
meta_combined_time$Group <- ifelse(grepl("Non-Progressor", meta_combined_time$Group),
                                   "Non-Progressor",
                                   meta_combined_time$Group)

case1_f4 <- flexiDEG.function4(case1_f1, meta_combined_time,validation_option = 1) 
 EN1 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[1]])]), ])
EN.95 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[2]])]), ]) 
EN.9 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[3]])]), ]) 
EN.85 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[4]])]), ])
EN.8 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[5]])]), ]) 
EN.75 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[6]])]), ]) 
EN.7 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[7]])]), ]) 
EN.65 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[8]])]), ]) 
EN.6 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[9]])]), ])
EN.55 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[10]])]), ]) 
EN.5 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[11]])]), ]) 
EN.45 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[12]])]), ]) 
EN.4 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[13]])]), ]) 
EN.35 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[14]])]), ]) 
EN.3 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[15]])]), ]) 
EN.25 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[16]])]), ]) 
EN.2 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[17]])]), ]) 
EN.15 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[18]])]), ]) 
EN.1 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[19]])]), ]) 
EN.05 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[20]])]), ]) 
EN.0 <- na.omit(case1_f1[unique(rownames(case1_f1)[as_vector(case1_f4[[21]])]), ]) 

# Color palettes
coul <- colorRampPalette(brewer.pal(11, "RdBu"))(100) # Palette for gene heatmaps
coul_gsva <- colorRampPalette(brewer.pal(11, "PRGn"))(100) # Palette for gsva heatmaps
colSide <- flexiDEG.colors(meta_combined_time)
unique_colSide <- unique(colSide)

 EN <- na.omit(case1_f2)
#dev.off()
heatmap.2(as.matrix(EN), scale="row", col=coul_gsva, key= T, xlab="", ylab="", 
          margins=c(7,7), ColSideColors=colSide, trace="none", key.title=NA, 
          key.ylab=NA, keysize=0.8, dendrogram="both")
ggbiplot(prcomp(t(EN), scale.=T), ellipse=T, groups=names(colSide), var.axes=F, 
         var.scale=1, circle=T) + 
  theme_classic() + scale_color_manual(name="Group", values=colSide)


```



## Double Volcano Analysis- Early Vs Intermediate
```{r PCA}
#### Start Analysis ####

# Load necessary libraries
library(DESeq2)
library(ggplot2)
library(dplyr)



# Assuming case1_f1 is your bulk expression data and meta_combined is the metadata

# Step 1: Run DESeq2 for Early and Intermediate groups
# Subset data for Early and Intermediate

early_data <- combined_counts[, meta_combined$Time == "Early"]
early_data <- na.omit(early_data)
meta_early <- meta_combined[meta_combined$Time == "Early", ]

early_data <- flexiDEG.function1(early_data, meta_early, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = F, quality = T, variance = F,use_pseudobulk = F) # Select filters: 0, 0,  100000000
# Remove rows where row names start with "Gm" followed by a digit
early_data <- early_data[!grepl("^Gm[0-9]", rownames(early_data)), ]


intermediate_data <- combined_counts[, meta_combined$Time == "Intermediate"]
intermediate_data <-na.omit(intermediate_data)
meta_intermediate <- meta_combined[meta_combined$Time == "Intermediate", ]
intermediate_data <- flexiDEG.function1(intermediate_data, meta_intermediate, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = F, quality = T, variance = F,use_pseudobulk = F) # Select filters: 0, 0,  100000000
intermediate_data <- intermediate_data[!grepl("^Gm[0-9]", rownames(intermediate_data)), ]

# DESeq2 analysis for Early Time
dds_early <- DESeqDataSetFromMatrix(countData = early_data, colData = meta_early, design = ~ Batch+Group)
dds_early <- DESeq(dds_early)
results_early <- as.data.frame(results(dds_early, contrast = c("Group", "Progressor", "Non-Progressor")))

# DESeq2 analysis for intermediate Time
dds_intermediate <- DESeqDataSetFromMatrix(countData = intermediate_data, colData = meta_intermediate, design = ~ Batch+Group)
dds_intermediate <- DESeq(dds_intermediate)
results_intermediate <- as.data.frame(results(dds_intermediate, contrast = c("Group", "Progressor", "Non-Progressor")))

# Replace NA p values with 1
results_early$padj[is.na(results_early$padj)] <- 1
results_intermediate$padj[is.na(results_intermediate$padj)] <- 1


# Step 2: Merge the results and categorize based on thresholds
results_early$logFC_early <- results_early$log2FoldChange
results_early$pval_early <- results_early$padj
results_early <- results_early[, !colnames(results_early) %in% c("log2FoldChange", "padj")]

results_intermediate$logFC_intermediate <- results_intermediate$log2FoldChange
results_intermediate$pval_intermediate <- results_intermediate$padj
results_intermediate <- results_intermediate[, !colnames(results_intermediate) %in% c("log2FoldChange", "padj")]

results_early$gene <- rownames(results_early)
results_intermediate$gene <- rownames(results_intermediate)

# Merge the results
merged_results <- merge(results_early, results_intermediate, by = "gene", suffixes = c("_early", "_intermediate"))

# Thresholds
logFC_threshold <- 1
pval_threshold <- 0.1  # Adjusted p-value threshold

# Define regulation categories based on fold change and p-value cutoffs
merged_results$regulation <- "Not Significant"  # Default category
merged_results$regulation[merged_results$logFC_early > logFC_threshold & merged_results$pval_early < pval_threshold] <- "Up_Early"
merged_results$regulation[merged_results$logFC_early < -logFC_threshold & merged_results$pval_early < pval_threshold] <- "Down_Early"
merged_results$regulation[merged_results$logFC_intermediate > logFC_threshold & merged_results$pval_intermediate < pval_threshold] <- "Up_Intermediate"
merged_results$regulation[merged_results$logFC_intermediate < -logFC_threshold & merged_results$pval_intermediate < pval_threshold] <- "Down_Intermediate"
# Both Upregulated condition
merged_results$regulation[merged_results$logFC_early > logFC_threshold & 
                            merged_results$logFC_intermediate > logFC_threshold & 
                            (merged_results$pval_early < pval_threshold & 
                               merged_results$pval_intermediate < pval_threshold)] <- "Both_Up"
# Both Downregulated condition
merged_results$regulation[merged_results$logFC_early < -logFC_threshold & 
                            merged_results$logFC_intermediate < -logFC_threshold & 
                            (merged_results$pval_early < pval_threshold & 
                               merged_results$pval_intermediate < pval_threshold)] <- "Both_Down"

# Upregulated to Downregulated condition
merged_results$regulation[merged_results$logFC_early > logFC_threshold & 
                            merged_results$logFC_intermediate < -logFC_threshold & 
                            (merged_results$pval_early < pval_threshold & 
                               merged_results$pval_intermediate < pval_threshold)] <- "Up_Down"

# Downregulated to Upregulated condition
merged_results$regulation[merged_results$logFC_early < -logFC_threshold & 
                            merged_results$logFC_intermediate > logFC_threshold & 
                            (merged_results$pval_early < pval_threshold & 
                               merged_results$pval_intermediate < pval_threshold)] <- "Down_Up"

unique(merged_results$regulation)

# Step 3: Plot the Double Volcano Plot
library(ggplot2)
library(ggrepel)

ggplot(merged_results, aes(x = logFC_early, y = logFC_intermediate)) +
  # Main plot points
  geom_point(
    aes(color = regulation, size = ifelse(regulation == "Not Significant", 1, 4)),
    alpha = 0.8
  ) +
  
  # Custom color palette with clarity in mind
  scale_color_manual(values = c(
"Up_Early" = "#E69F00",           # Darker amber (vibrant and clear for upregulation)
"Up_Intermediate" = "#D76E14",    # Deep orange (distinct from early upregulation)
"Down_Early" = "#3366CC",         # Strong medium blue (clean and vibrant)
"Down_Intermediate" = "#003F5C",  # Deep indigo (distinct and rich for intermediate downregulation)
"Both_Up" = "#9C1B30",            # Deep red (vivid and clear for both upregulated)
"Both_Down" = "#004225",          # Deep emerald green (rich and distinct for both downregulated)
"Up_Down" = "#8E44AD",            # Dark purple (stands out for transition from up to down)
"Down_Up" = "#FF6F91",                # Teal (contrasts well for transition from down to up)
"Not Significant" = "#999999"     # Subtle gray (neutral and unobtrusive for non-significant)


  )) +
  
  # Labels and axis titles
  labs(
    x = expression(Log[2] ~ "Fold Change (Early)"),
    y = expression(Log[2] ~ "Fold Change (Intermediate)"),
    color = "Regulation Type"
  ) +
  
  # Add threshold lines for log fold changes
  geom_vline(xintercept = c(-1.0, 1.0), linetype = "dashed", color = "black", size = 0.6) +
  geom_hline(yintercept = c(-1.0, 1.0), linetype = "dashed", color = "black", size = 0.6) +
  
  # Highlight genes with FC > 1 or < -1 for both conditions with adjusted p-value < threshold in at least one
  geom_text_repel(
    data = subset(merged_results, 
                  ((logFC_early > 1 & logFC_intermediate > 1) & 
                     (pval_early < 0.1 & pval_intermediate< 0.1)) |
                    ((logFC_early < -1 & logFC_intermediate < -1) & 
                       (pval_early < 0.1 & pval_intermediate < 0.1)) |
                    ((logFC_early >= 1 | logFC_early <= -1) & 
                       (pval_early < 0.1)) | 
                     ((logFC_early >= 1 & logFC_intermediate <= -1) & 
                       (pval_early < 0.1 & pval_intermediate< 0.1)) | 
                     ((logFC_early <= -1 & logFC_intermediate >= -1) & 
                       (pval_early < 0.1 & pval_intermediate< 0.1)) | 
                       ((logFC_intermediate >= 1 | logFC_intermediate <= -1) & (pval_intermediate<0.1))),
    aes(label = gene),
    size = 4,
    box.padding = 0.3,
    max.overlaps = Inf,  # Adjust to display all genes meeting the criteria
    color = "black",
    segment.color = 'grey70'
  ) +
  
  # Adjust theme for publication quality
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.position = "none",  # Remove legend for colors
    #legend.position = "bottom",  # Move the legend to the right
    #legend.title = element_text(size = 14, face = "bold"),  # Increase the title size
    #legend.text = element_text(size = 12),  # Increase the legend text size
    panel.grid = element_line(color = "grey90")
  ) +
  
  # Custom size scale
  scale_size_identity() +  # Ensure the size adjustment works as intended
  
  # Limit y-axis to a maximum value of 10
  scale_y_continuous(limits = c(NA, 10))  # Use NA to keep the lower bound unchanged

# Save the plot as PNG
ggsave("Volcanoplot_Early_Intermediate.png", width = 8, height = 6, dpi = 600)
# Save the merged_results data frame to a CSV file
write.csv(merged_results, file = "DEGAnalysis_DoubleVolcano_EarlyIntermediate_padj.csv", row.names = FALSE)
```

## Double Volcano Analysis-  Intermediate vs Late
```{r DVA- Intermediate vs Late}
#### Start Analysis ####

# Load necessary libraries
library(DESeq2)
library(ggplot2)
library(dplyr)



# Assuming case1_f1 is your bulk expression data and meta_combined is the metadata

# Step 1: Run DESeq2 for intermediate and late groups
# Subset data for intermediate and late

intermediate_data <- combined_counts[, meta_combined$Time == "Intermediate"]
intermediate_data <- na.omit(intermediate_data)
meta_intermediate <- meta_combined[meta_combined$Time == "Intermediate", ]

intermediate_data <- flexiDEG.function1(intermediate_data, meta_intermediate, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = F, quality = T, variance = F,use_pseudobulk = F) # Select filters: 0, 0,  100000000
# Remove rows where row names start with "Gm" followed by a digit
intermediate_data <- intermediate_data[!grepl("^Gm[0-9]", rownames(intermediate_data)), ]


late_data <- combined_counts[, meta_combined$Time == "Late"]
late_data <-na.omit(late_data)
meta_late <- meta_combined[meta_combined$Time == "Late", ]
late_data <- flexiDEG.function1(late_data, meta_late, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = F, quality = T, variance = F,use_pseudobulk = F) # Select filters: 0, 0,  100000000
late_data <- late_data[!grepl("^Gm[0-9]", rownames(late_data)), ]

# DESeq2 analysis for intermediate Time
dds_intermediate <- DESeqDataSetFromMatrix(countData = intermediate_data, colData = meta_intermediate, design = ~ Batch+Group)
dds_intermediate <- DESeq(dds_intermediate)
results_intermediate <- as.data.frame(results(dds_intermediate, contrast = c("Group", "Progressor", "Non-Progressor")))

# DESeq2 analysis for late Time
dds_late <- DESeqDataSetFromMatrix(countData = late_data, colData = meta_late, design = ~ Batch+Group)
dds_late <- DESeq(dds_late)
results_late <- as.data.frame(results(dds_late, contrast = c("Group", "Progressor", "Non-Progressor")))

# Replace NA p values with 1
results_intermediate$padj[is.na(results_intermediate$padj)] <- 1
results_late$padj[is.na(results_late$padj)] <- 1


# Step 2: Merge the results and categorize based on thresholds
results_intermediate$logFC_intermediate <- results_intermediate$log2FoldChange
results_intermediate$pval_intermediate <- results_intermediate$padj
results_intermediate <- results_intermediate[, !colnames(results_intermediate) %in% c("log2FoldChange", "padj")]

results_late$logFC_late <- results_late$log2FoldChange
results_late$pval_late <- results_late$padj
results_late <- results_late[, !colnames(results_late) %in% c("log2FoldChange", "padj")]

results_intermediate$gene <- rownames(results_intermediate)
results_late$gene <- rownames(results_late)

# Merge the results
merged_results <- merge(results_intermediate, results_late, by = "gene", suffixes = c("_intermediate", "_late"))

# Thresholds
logFC_threshold <- 1
pval_threshold <- 0.1  # Adjusted p-value threshold

# Define regulation categories based on fold change and p-value cutoffs
merged_results$regulation <- "Not Significant"  # Default category
merged_results$regulation[merged_results$logFC_intermediate > logFC_threshold & merged_results$pval_intermediate < pval_threshold] <- "Up_intermediate"
merged_results$regulation[merged_results$logFC_intermediate < -logFC_threshold & merged_results$pval_intermediate < pval_threshold] <- "Down_intermediate"
merged_results$regulation[merged_results$logFC_late > logFC_threshold & merged_results$pval_late < pval_threshold] <- "Up_late"
merged_results$regulation[merged_results$logFC_late < -logFC_threshold & merged_results$pval_late < pval_threshold] <- "Down_late"

# Both Upregulated condition
merged_results$regulation[merged_results$logFC_intermediate > logFC_threshold & 
                            merged_results$logFC_late > logFC_threshold & 
                            (merged_results$pval_intermediate < pval_threshold & 
                               merged_results$pval_late < pval_threshold)] <- "Both_Up"


# Both Downregulated condition
merged_results$regulation[merged_results$logFC_intermediate < -logFC_threshold & 
                            merged_results$logFC_late < -logFC_threshold & 
                            (merged_results$pval_intermediate < pval_threshold & 
                               merged_results$pval_late < pval_threshold)] <- "Both_Down"
# Up in Intermediate and Down in Late (Up_Down)
merged_results$regulation[merged_results$logFC_intermediate > logFC_threshold & 
                            merged_results$logFC_late < -logFC_threshold & 
                            (merged_results$pval_intermediate < pval_threshold & 
                               merged_results$pval_late < pval_threshold)] <- "Up_Down"

# Down in Intermediate and Up in Late (Down_Up)
merged_results$regulation[merged_results$logFC_intermediate < -logFC_threshold & 
                            merged_results$logFC_late > logFC_threshold & 
                            (merged_results$pval_intermediate < pval_threshold & 
                               merged_results$pval_late < pval_threshold)] <- "Down_Up"

unique(merged_results$regulation)

# Step 3: Plot the Double Volcano Plot
library(ggplot2)
library(ggrepel)

ggplot(merged_results, aes(x = logFC_intermediate, y = logFC_late)) +
  # Main plot points
  geom_point(
    aes(color = regulation, size = ifelse(regulation == "Not Significant", 1, 4)),
    alpha = 0.8
  ) +
  
  # Custom color palette with clarity in mind
  scale_color_manual(values = c(
    "Up_intermediate" = "#D76E14",         # Orange
    "Down_intermediate" = "#003F5C",       # Teal green
    "Up_late" = "#E9967A",  
    "Down_late" = "#2E8B57",# Dark green
    "Both_Up" = "#9C1B30",         # Red
    "Both_Down" = "#004225",        # Dark navy
    "Up_Down" = "#8E44AD",            # Dark purple (stands out for transition from up to down)
    "Down_Up" = "#FF6F91",                # Teal (contrasts well for transition from down to up)
    "Not Significant" = "#999999"     # Light gray

  )) +
  
  # Labels and axis titles
  labs(
    x = expression(Log[2] ~ "Fold Change (Intermediate)"),
    y = expression(Log[2] ~ "Fold Change (Late)"),
    color = "Regulation Type"
  ) +
  
  # Add threshold lines for log fold changes
  geom_vline(xintercept = c(-1.0, 1.0), linetype = "dashed", color = "black", size = 0.6) +
  geom_hline(yintercept = c(-1.0, 1.0), linetype = "dashed", color = "black", size = 0.6) +
  
  # Highlight genes with FC > 1 or < -1 for both conditions with adjusted p-value < threshold in at least one
  geom_text_repel(
    data = subset(merged_results, 
                  ((logFC_intermediate > 1 & logFC_late > 1) & 
                     (pval_intermediate < 0.1 & pval_late< 0.1)) |
                    ((logFC_intermediate < -1 & logFC_late < -1) & 
                       (pval_intermediate < 0.1 & pval_late < 0.1)) |
                    ((logFC_intermediate >= 1 | logFC_intermediate <= -1) & 
                       (pval_intermediate < 0.1)) | 
                    ((logFC_intermediate  >= 1 & logFC_late <= -1) & 
                       (pval_intermediate < 0.1 & pval_late < 0.1)) |
                    ((logFC_intermediate > 1 & logFC_late < -1) & 
                       (pval_intermediate < 0.1 & pval_late < 0.1)) |
                       ((logFC_late >= 1 | logFC_late <= -1) & (pval_late<0.1))),
    aes(label = gene),
    size = 4,
    box.padding = 0.3,
    max.overlaps = Inf,  # Adjust to display all genes meeting the criteria
    color = "black",
    segment.color = 'grey70'
  ) +
  
  # Adjust theme for publication quality
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.position = "none",  # Move the legend to the right
    #legend.position = "right",  # Move the legend to the right
    #legend.title = element_text(size = 14, face = "bold"),  # Increase the title size
    #legend.text = element_text(size = 12),  # Increase the legend text size
    panel.grid = element_line(color = "grey90")
  ) +
  
  # Custom size scale
  scale_size_identity() +  # Ensure the size adjustment works as intended
  scale_x_continuous(limits = c(NA, 12)) +
  # Limit y-axis to a maximum value of 10
  scale_y_continuous(limits = c(NA, 10))  # Use NA to keep the lower bound unchanged
ggsave("Volcanoplot_Intermediate_Late_padj.png", width = 8, height = 6, dpi = 600)
# Save the merged_results data frame to a CSV file
write.csv(merged_results, file = "DEGAnalysis_DoubleVolcano_IntermediateLate_padj.csv", row.names = FALSE)
```


## Double Volcano Analysis-  Early vs Late
```{r DVA- Early vs Late}
#### Start Analysis ####

# Load necessary libraries
library(DESeq2)
library(ggplot2)
library(dplyr)



# Assuming case1_f1 is your bulk expression data and meta_combined is the metadata

# Step 1: Run DESeq2 for early and late groups
# Subset data for early and late

early_data <- combined_counts[, meta_combined$Time == "Early"]
early_data <- na.omit(early_data)
meta_early <- meta_combined[meta_combined$Time == "Early", ]

early_data <- flexiDEG.function1(early_data, meta_early, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = F, quality = T, variance = F,use_pseudobulk = F) # Select filters: 0, 0,  100000000
# Remove rows where row names start with "Gm" followed by a digit
early_data <- early_data[!grepl("^Gm[0-9]", rownames(early_data)), ]


late_data <- combined_counts[, meta_combined$Time == "Late"]
late_data <-na.omit(late_data)
meta_late <- meta_combined[meta_combined$Time == "Late", ]
late_data <- flexiDEG.function1(late_data, meta_late, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = F, quality = T, variance = F,use_pseudobulk = F) # Select filters: 0, 0,  100000000
late_data <- late_data[!grepl("^Gm[0-9]", rownames(late_data)), ]

# DESeq2 analysis for early Time
dds_early <- DESeqDataSetFromMatrix(countData = early_data, colData = meta_early, design = ~ Batch+Group)
dds_early <- DESeq(dds_early)
results_early <- as.data.frame(results(dds_early, contrast = c("Group", "Progressor", "Non-Progressor")))

# DESeq2 analysis for late Time
dds_late <- DESeqDataSetFromMatrix(countData = late_data, colData = meta_late, design = ~ Batch+Group)
dds_late <- DESeq(dds_late)
results_late <- as.data.frame(results(dds_late, contrast = c("Group", "Progressor", "Non-Progressor")))

# Replace NA p values with 1
results_early$padj[is.na(results_early$padj)] <- 1
results_late$padj[is.na(results_late$padj)] <- 1


# Step 2: Merge the results and categorize based on thresholds
results_early$logFC_early <- results_early$log2FoldChange
results_early$pval_early <- results_early$padj
results_early <- results_early[, !colnames(results_early) %in% c("log2FoldChange", "padj")]

results_late$logFC_late <- results_late$log2FoldChange
results_late$pval_late <- results_late$padj
results_late <- results_late[, !colnames(results_late) %in% c("log2FoldChange", "padj")]

results_early$gene <- rownames(results_early)
results_late$gene <- rownames(results_late)

# Merge the results
merged_results <- merge(results_early, results_late, by = "gene", suffixes = c("_early", "_late"))

# Thresholds
logFC_threshold <- 1
pval_threshold <- 0.3  # Adjusted p-value threshold

# Define regulation categories based on fold change and p-value cutoffs
merged_results$regulation <- "Not Significant"  # Default category
merged_results$regulation[merged_results$logFC_early > logFC_threshold & merged_results$pval_early < pval_threshold] <- "Up_early"
merged_results$regulation[merged_results$logFC_early < -logFC_threshold & merged_results$pval_early < pval_threshold] <- "Down_early"
merged_results$regulation[merged_results$logFC_late > logFC_threshold & merged_results$pval_late < pval_threshold] <- "Up_late"
merged_results$regulation[merged_results$logFC_late < -logFC_threshold & merged_results$pval_late < pval_threshold] <- "Down_late"

# Both Upregulated condition
merged_results$regulation[merged_results$logFC_early > logFC_threshold & 
                            merged_results$logFC_late > logFC_threshold & 
                            (merged_results$pval_early < pval_threshold & 
                               merged_results$pval_late < pval_threshold)] <- "Both_Up"


# Both Downregulated condition
merged_results$regulation[merged_results$logFC_early < -logFC_threshold & 
                            merged_results$logFC_late < -logFC_threshold & 
                            (merged_results$pval_early < pval_threshold & 
                               merged_results$pval_late < pval_threshold)] <- "Both_Down"
# Up in early and Down in Late (Up_Down)
merged_results$regulation[merged_results$logFC_early > logFC_threshold & 
                            merged_results$logFC_late < -logFC_threshold & 
                            (merged_results$pval_early < pval_threshold & 
                               merged_results$pval_late < pval_threshold)] <- "Up_Down"

# Down in early and Up in Late (Down_Up)
merged_results$regulation[merged_results$logFC_early < -logFC_threshold & 
                            merged_results$logFC_late > logFC_threshold & 
                            (merged_results$pval_early < pval_threshold & 
                               merged_results$pval_late < pval_threshold)] <- "Down_Up"

unique(merged_results$regulation)

# Step 3: Plot the Double Volcano Plot
library(ggplot2)
library(ggrepel)

ggplot(merged_results, aes(x = logFC_early, y = logFC_late)) +
  # Main plot points
  geom_point(
    aes(color = regulation, size = ifelse(regulation == "Not Significant", 1, 4)),
    alpha = 0.8
  ) +
  
  # Custom color palette with clarity in mind
  scale_color_manual(values = c(
    "Up_early" = "#E69F00",         # Orange
    "Down_early" = "#3366CC",       # Teal green
    "Up_late" = "#E9967A",  
    "Down_late" = "#2E8B57",# Dark green
    "Both_Up" = "#9C1B30",         # Red
    "Both_Down" = "#004225",        # Dark navy
    "Up_Down" = "#8E44AD",            # Dark purple (stands out for transition from up to down)
    "Down_Up" = "#FF6F91",                # Teal (contrasts well for transition from down to up)
    "Not Significant" = "#999999"     # Light gray

  )) +
  
  # Labels and axis titles
  labs(
    x = expression(Log[2] ~ "Fold Change (Early)"),
    y = expression(Log[2] ~ "Fold Change (Late)"),
    color = "Regulation Type"
  ) +
  
  # Add threshold lines for log fold changes
  geom_vline(xintercept = c(-1.0, 1.0), linetype = "dashed", color = "black", size = 0.6) +
  geom_hline(yintercept = c(-1.0, 1.0), linetype = "dashed", color = "black", size = 0.6) +
  
  # Highlight genes with FC > 1 or < -1 for both conditions with adjusted p-value < threshold in at least one
  geom_text_repel(
    data = subset(merged_results, 
                  ((logFC_early > 1 & logFC_late > 1) & 
                     (pval_early < 0.1 & pval_late< 0.1)) |
                    ((logFC_early < -1 & logFC_late < -1) & 
                       (pval_early < 0.1 & pval_late < 0.1)) |
                    ((logFC_early >= 1 | logFC_early <= -1) & 
                       (pval_early < 0.1)) | 
                    ((logFC_early  >= 1 & logFC_late <= -1) & 
                       (pval_early < 0.1 & pval_late < 0.1)) |
                    ((logFC_early > 1 & logFC_late < -1) & 
                       (pval_early < 0.1 & pval_late < 0.1)) |
                       ((logFC_late >= 1 | logFC_late <= -1) & (pval_late<0.1))),
    aes(label = gene),
    size = 4,
    box.padding = 0.3,
    max.overlaps = Inf,  # Adjust to display all genes meeting the criteria
    color = "black",
    segment.color = 'grey70'
  ) +
  
  # Adjust theme for publication quality
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.position = "none",  # Move the legend to the right
    #legend.position = "right",  # Move the legend to the right
    #legend.title = element_text(size = 14, face = "bold"),  # Increase the title size
    #legend.text = element_text(size = 12),  # Increase the legend text size
    panel.grid = element_line(color = "grey90")
  ) +
  
  # Custom size scale
  scale_size_identity() +  # Ensure the size adjustment works as intended
  scale_x_continuous(limits = c(NA, 6)) +
  # Limit y-axis to a maximum value of 10
  scale_y_continuous(limits = c(NA, 10))  # Use NA to keep the lower bound unchanged
ggsave("Volcanoplot_early_Late_padj.png", width = 8, height = 6, dpi = 600)
# Save the merged_results data frame to a CSV file
write.csv(merged_results, file = "DEGAnalysis_DoubleVolcano_earlyLate_padj.csv", row.names = FALSE)
```


## Print Legend
```{r Legend, echo=FALSE}
library(ggplot2)

# Define the colors and labels
colors <- c(
  "Upregulated Early" = "#E69F00",
  "Downregulated Early" = "#3366CC",
  "Upregulated Intermediate" = "#D76E14",
  "Downregulated Intermediate" = "#003F5C",
  "Upregulated late" = "#E9967A",
  "Downregulated late" = "#2E8B57",
  "Upregulated Then Downregulated" = "#8E44AD",
  "Downregulated Then Upregulated" = "#FF6F91",
  "Both Upregulated" = "#9C1B30",
  "Both Downregulated" = "#004225",
  "Not Significant" = "#999999"
)

# Create a dummy data frame for the legend
legend_data <- data.frame(
  Category = names(colors),
  Color = colors,
  y = rep(1, length(colors))  # Create a constant y for each category
)

# Ensure the order of categories matches the order in the colors vector
legend_data$Category <- factor(legend_data$Category, levels = names(colors))

# Create a dummy plot to display only the legend
legend_plot <- ggplot(legend_data, aes(x = Category, y = y, fill = Category)) +
  geom_tile(show.legend = TRUE) +
  scale_fill_manual(values = colors) +
  theme_void() +  # Remove axis labels and ticks
  theme(
    legend.position = "right", 
    legend.title = element_blank(), 
    legend.text = element_text(size = 12),  # Adjust legend text size
    legend.key.size = unit(1, "lines"),  # Adjust box size
    axis.text = element_blank(),  # Remove x-axis text
    axis.ticks = element_blank()  # Remove x-axis ticks
  )

# Print the legend plot
print(legend_plot)

# Save the legend plot using ggsave
ggsave("doublevolcano_legend_plot.png", plot = legend_plot, width = 10, height = 3, dpi = 300)




```

## GSEA Analysis


### Early Stage Analysis
```{r GSEAEarly, echo=FALSE}



# Select columns in combined_counts that match the remaining sample names in meta_combined
combined_counts <- combined_counts[, meta_combined$Samples]  # Ensure Sample_IDs match column names in 

# Load necessary libraries
library(DESeq2)
library(ggplot2)
library(dplyr)

# Filter Data for time
meta_combined_early <- meta_combined[meta_combined$Time == "Early", ]
# Ensure no duplicate sample names
combined_counts_early <- meta_combined_early[!duplicated(meta_combined_early$Samples), ]

# Filter combined_counts to keep only the samples in the subset metadata
combined_counts_early <- combined_counts[, colnames(combined_counts) %in% meta_combined_early$Samples]

combined_counts_early <- combined_counts_early[, meta_combined_early$Samples]  # Ensure Sample_IDs match column names in 
# Remove rows with NA values
combined_counts_early <- combined_counts_early[complete.cases(combined_counts_early), ]

case1_f1 <- flexiDEG.function1(combined_counts_early, meta_combined_early, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = F, quality = T, variance = F,use_pseudobulk = F) # Select filters: 0, 0, 1000000


combined_counts_early <-case1_f1
# DESeq2 analysis for Week 6
dds_Early <- DESeqDataSetFromMatrix(countData = combined_counts_early, colData = meta_combined_early, design = ~ Batch+Group)
dds_Early <- DESeq(dds_Early)
results_Early <- as.data.frame(results(dds_Early, contrast = c("Group", "Progressor", "Non-Progressor")))
results_Early$gene <- rownames(results_Early)

# GSEA ----------------------------------------------------------------- 

# Prepare the ranked list for Islet
results_Early <- results_Early[, c("gene", "log2FoldChange", "padj")]
results_Early <- results_Early[!is.na(results_Early$log2FoldChange), ]
results_Early <- results_Early[order(results_Early$log2FoldChange, decreasing = TRUE), ]
lfc_vector_early <- setNames(results_Early$log2FoldChange, results_Early$gene)


# CellTypes Pathways

#BiocManager::install("clusterProfiler")
library(clusterProfiler)
biocarta_gene_sets <- msigdbr(species="Mus musculus", category="C8") # Large df w/ categories
mm_hallmark_sets <- split(biocarta_gene_sets$gene_symbol, # Genes to split into pathways, by ensembl
                      biocarta_gene_sets$gs_name) # Pathway names
mm_hallmark_df <- data.frame(
  gs_name = rep(names(mm_hallmark_sets), sapply(mm_hallmark_sets, length)),  # Pathway names
  gene_symbol = unlist(mm_hallmark_sets)  # Flatten the list into a single vector
)
# Define the keywords of interest
# keywords <- c("T_cell", "NK", "Macrophage", "Monocyte", "Dendritic", 
#               "DC", "NKT", "Neutrophil", "B_cell", "myeloid", "lymphoid","lymphocyte","mast_cell","Antigen_presenting_cell","Immune")
# 
# # Filter the gene sets
# filtered_mm_hallmark_sets <- mm_hallmark_sets[grepl(paste(keywords, collapse = "|"), names(mm_hallmark_sets), ignore.case = TRUE)]

# Check the structure of mm_hallmark_sets
#str(mm_hallmark_sets)
# If mm_hallmark_sets is a list, convert it to a data frame
# Replace `your_data` with the appropriate structure that holds the gene sets.
# Convert the list to a data frame

# Check the structure of the new data frame
#str(mm_hallmark_df)
# Perform GSEA for Islet
gsea_results_early <- GSEA(
  geneList = lfc_vector_early, # Your ordered ranked gene list for Islet
  minGSSize = 5, # Minimum gene set size
  maxGSSize = 500, # Maximum gene set size
  pvalueCutoff = 1, # p-value cutoff
  eps = 0, # Boundary for calculating the p value
  seed = TRUE, # Set seed for reproducibility
  pAdjustMethod = "BH", # Benjamini-Hochberg correction
  TERM2GENE = mm_hallmark_df  # Use the new data frame
)

# Extract results for Islet
gsea_results_early_df <- as.data.frame(gsea_results_early)


library(ggplot2)

# Color gradient function for NES
color_gradient <- scale_fill_gradient2(
  low = "red",      # Low NES values (negative)
  mid = "white",    # Midpoint (zero)
  high = "blue",    # High NES values (positive)
  midpoint = 0,
  limits = c(min(gsea_results_early_df$NES), max(gsea_results_early_df$NES)),
  name = "NES"
)

ggplot(gsea_results_early_df, aes(x = reorder(Description, NES), y = NES, fill = NES)) +
     geom_bar(stat = "identity", show.legend = TRUE) +
     coord_flip() +
     color_gradient +
     labs(title = "Top GSEA Results for Early Timepoint",
          x = "Pathway",
          y = "Normalized Enrichment Score (NES)") +
     theme_minimal(base_size = 14) +
     theme(
         plot.title = element_text(hjust = 0.7, size = 20, face = "bold"),
         axis.title = element_text(size = 19),
         axis.text = element_text(size = 12),
         panel.grid.major = element_line(color = "grey90"),
         panel.grid.minor = element_blank(),
         legend.position = "bottom"
     )

# Metabolic and Immune Pathways
sets_hallmark <- msigdbr(species="Mus musculus", category="H") # Large df w/ categories
pwl_hallmark <- split(sets_hallmark$gene_symbol, # Genes to split into pathways, by ensembl
                      sets_hallmark$gs_name) # Pathway names
sets_reactome <- msigdbr(species="Mus musculus", subcategory="CP:REACTOME") # Large df w/ categories
pwl_reactome <- split(sets_reactome$gene_symbol, # Genes to split into pathways, by ensembl
                       sets_reactome$gs_name) # Pathway names
kegg_gene_sets <- msigdbr(species="Mus musculus", subcategory="CP:KEGG") # Large df w/ categories
pwl_kegg <- split(kegg_gene_sets$gene_symbol, # Genes to split into pathways, by ensembl
                  kegg_gene_sets$gs_name) # Pathway names
# biocarta_gene_sets <- msigdbr(species="Mus musculus", subcategory="CP:BIOCARTA") # Large df w/ categories
# pwl_biocarta <- split(biocarta_gene_sets$gene_symbol, # Genes to split into pathways, by ensembl
#                        biocarta_gene_sets$gs_name) # Pathway names
pwl_msigdbr <- c(pwl_hallmark, pwl_kegg,pwl_reactome,pwl_reactome) # Compile them all
length(pwl_reactome)

mm_metabolism_df <- data.frame(
  gs_name = rep(names(pwl_msigdbr), sapply(pwl_msigdbr, length)),  # Pathway names
  gene_symbol = unlist(pwl_msigdbr)  # Flatten the list into a single vector
)

gsea_results_early_metab <- GSEA(
  geneList = lfc_vector_early, # Your ordered ranked gene list for Islet
  minGSSize = 5, # Minimum gene set size
  maxGSSize = 500, # Maximum gene set size
  pvalueCutoff = 1, # p-value cutoff
  eps = 0, # Boundary for calculating the p value
  seed = TRUE, # Set seed for reproducibility
  pAdjustMethod = "BH", # Benjamini-Hochberg correction
  TERM2GENE = mm_metabolism_df  # Use the new data frame
)

# Extract results for Islet
gsea_results_early_metab_df <- as.data.frame(gsea_results_early_metab)


library(ggplot2)

# Color gradient function for NES
color_gradient <- scale_fill_gradient2(
  low = "red",      # Low NES values (negative)
  mid = "white",    # Midpoint (zero)
  high = "blue",    # High NES values (positive)
  midpoint = 0,
  limits = c(min(gsea_results_early_metab_df$NES), max(gsea_results_early_metab_df$NES)),
  name = "NES"
)

ggplot(gsea_results_early_metab_df, aes(x = reorder(Description, NES), y = NES, fill = NES)) +
     geom_bar(stat = "identity", show.legend = TRUE) +
     coord_flip() +
     color_gradient +
     labs(title = "Top GSEA Results for Early Timepoint",
          x = "Pathway",
          y = "Normalized Enrichment Score (NES)") +
     theme_minimal(base_size = 14) +
     theme(
         plot.title = element_text(hjust = 0.7, size = 20, face = "bold"),
         axis.title = element_text(size = 19),
         axis.text = element_text(size = 12),
         panel.grid.major = element_line(color = "grey90"),
         panel.grid.minor = element_blank(),
         legend.position = "bottom"
     )

```


### Intermediate Stage Analysis

```{r GSEAIntermediate, echo=FALSE}
# Filter Data for time
meta_combined_intermediate <- meta_combined[meta_combined$Time == "Intermediate", ]
# Ensure no duplicate sample names
combined_counts_intermediate <- meta_combined_intermediate[!duplicated(meta_combined_intermediate$Samples), ]

# Filter combined_counts to keep only the samples in the subset metadata
combined_counts_intermediate <- combined_counts[, colnames(combined_counts) %in% meta_combined_intermediate$Samples]

combined_counts_intermediate <- combined_counts_intermediate[, meta_combined_intermediate$Samples]  # Ensure Sample_IDs match column names in 
# Remove rows with NA values
combined_counts_intermediate <- combined_counts_intermediate[complete.cases(combined_counts_intermediate), ]

case1_intermediate <- flexiDEG.function1(combined_counts_intermediate, meta_combined_intermediate, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = F, quality = T, variance = F,use_pseudobulk = F) # Select filters: 0, 0, 10000000


combined_counts_intermediate <-case1_intermediate
# DESeq2 analysis for Week 6
dds_intermediate <- DESeqDataSetFromMatrix(countData = combined_counts_intermediate, colData = meta_combined_intermediate, design = ~ Batch+Group)
dds_intermediate <- DESeq(dds_intermediate)
results_intermediate <- as.data.frame(results(dds_intermediate, contrast = c("Group", "Progressor", "Non-Progressor")))
results_intermediate$gene <- rownames(results_intermediate)

# GSEA ----------------------------------------------------------------- 

# Prepare the ranked list for Islet
results_intermediate <- results_intermediate[, c("gene", "log2FoldChange", "padj")]
results_intermediate <- results_intermediate[!is.na(results_intermediate$log2FoldChange), ]
results_intermediate <- results_intermediate[order(results_intermediate$log2FoldChange, decreasing = TRUE), ]
lfc_vector_intermediate <- setNames(results_intermediate$log2FoldChange, results_intermediate$gene)



# Perform GSEA for Islet
gsea_results_intermediate <- GSEA(
  geneList = lfc_vector_intermediate, # Your ordered ranked gene list for Islet
  minGSSize = 5, # Minimum gene set size
  maxGSSize = 500, # Maximum gene set size
  pvalueCutoff = 1, # p-value cutoff
  eps = 0, # Boundary for calculating the p value
  seed = TRUE, # Set seed for reproducibility
  pAdjustMethod = "BH", # Benjamini-Hochberg correction
  TERM2GENE = mm_hallmark_df  # Use the new data frame
)

# Extract results for Islet
gsea_results_intermediate_df <- as.data.frame(gsea_results_intermediate)


library(ggplot2)

# Color gradient function for NES
color_gradient <- scale_fill_gradient2(
  low = "red",      # Low NES values (negative)
  mid = "white",    # Midpoint (zero)
  high = "blue",    # High NES values (positive)
  midpoint = 0,
  limits = c(min(gsea_results_intermediate_df$NES), max(gsea_results_intermediate_df$NES)),
  name = "NES"
)

ggplot(gsea_results_intermediate_df, aes(x = reorder(Description, NES), y = NES, fill = NES)) +
     geom_bar(stat = "identity", show.legend = TRUE) +
     coord_flip() +
     color_gradient +
     labs(title = "Top GSEA Results for Early Timepoint",
          x = "Pathway",
          y = "Normalized Enrichment Score (NES)") +
     theme_minimal(base_size = 14) +
     theme(
         plot.title = element_text(hjust = 0.7, size = 20, face = "bold"),
         axis.title = element_text(size = 19),
         axis.text = element_text(size = 12),
         panel.grid.major = element_line(color = "grey90"),
         panel.grid.minor = element_blank(),
         legend.position = "bottom"
     )

# Metabolism Pathways


gsea_results_intermediate_metab <- GSEA(
  geneList = lfc_vector_intermediate, # Your ordered ranked gene list for Islet
  minGSSize = 5, # Minimum gene set size
  maxGSSize = 500, # Maximum gene set size
  pvalueCutoff = 1, # p-value cutoff
  eps = 0, # Boundary for calculating the p value
  seed = TRUE, # Set seed for reproducibility
  pAdjustMethod = "BH", # Benjamini-Hochberg correction
  TERM2GENE = mm_metabolism_df  # Use the new data frame
)

# Extract results for Islet
gsea_results_intermediate_metab_df <- as.data.frame(gsea_results_intermediate_metab)


library(ggplot2)

# Color gradient function for NES
color_gradient <- scale_fill_gradient2(
  low = "red",      # Low NES values (negative)
  mid = "white",    # Midpoint (zero)
  high = "blue",    # High NES values (positive)
  midpoint = 0,
  limits = c(min(gsea_results_intermediate_metab_df$NES), max(gsea_results_intermediate_metab_df$NES)),
  name = "NES"
)

ggplot(gsea_results_intermediate_metab_df, aes(x = reorder(Description, NES), y = NES, fill = NES)) +
     geom_bar(stat = "identity", show.legend = TRUE) +
     coord_flip() +
     color_gradient +
     labs(title = "Top GSEA Results for Intermediate Timepoint",
          x = "Pathway",
          y = "Normalized Enrichment Score (NES)") +
     theme_minimal(base_size = 14) +
     theme(
         plot.title = element_text(hjust = 0.7, size = 20, face = "bold"),
         axis.title = element_text(size = 19),
         axis.text = element_text(size = 12),
         panel.grid.major = element_line(color = "grey90"),
         panel.grid.minor = element_blank(),
         legend.position = "bottom"
     )

```
### Late Stage Analysis
```{r GSEALate, echo=FALSE}
# Filter Data for time
meta_combined_late <- meta_combined[meta_combined$Time == "Late", ]
# Ensure no duplicate sample names
combined_counts_late <- meta_combined_late[!duplicated(meta_combined_late$Samples), ]

# Filter combined_counts to keep only the samples in the subset metadata
combined_counts_late <- combined_counts[, colnames(combined_counts) %in% meta_combined_late$Samples]

combined_counts_late <- combined_counts_late[, meta_combined_late$Samples]  # Ensure Sample_IDs match column names in 
# Remove rows with NA values
combined_counts_late <- combined_counts_late[complete.cases(combined_counts_late), ]

case1_late <- flexiDEG.function1(combined_counts_late, meta_combined_late, # Run Function 1
                         convert_genes = F, exclude_riken = T, exclude_pseudo = F,
                         batches = F, quality = T, variance = F,use_pseudobulk = F) # Select filters: 0, 0, 10000000


combined_counts_late <-case1_late
# DESeq2 analysis for Week 6
dds_late <- DESeqDataSetFromMatrix(countData = combined_counts_late, colData = meta_combined_late, design = ~ Batch+Group)
dds_late <- DESeq(dds_late)
results_late <- as.data.frame(results(dds_late, contrast = c("Group", "Progressor", "Non-Progressor")))
results_late$gene <- rownames(results_late)

# GSEA ----------------------------------------------------------------- 

# Prepare the ranked list for Islet
results_late <- results_late[, c("gene", "log2FoldChange", "padj")]
results_late <- results_late[!is.na(results_late$log2FoldChange), ]
results_late <- results_late[order(results_late$log2FoldChange, decreasing = TRUE), ]
lfc_vector_late <- setNames(results_late$log2FoldChange, results_late$gene)

# Perform GSEA for Islet
gsea_results_late <- GSEA(
  geneList = lfc_vector_late, # Your ordered ranked gene list for Islet
  minGSSize = 5, # Minimum gene set size
  maxGSSize = 500, # Maximum gene set size
  pvalueCutoff = 1, # p-value cutoff
  eps = 0, # Boundary for calculating the p value
  seed = TRUE, # Set seed for reproducibility
  pAdjustMethod = "BH", # Benjamini-Hochberg correction
  TERM2GENE = mm_hallmark_df  # Use the new data frame
)

# Extract results for Islet
gsea_results_late_df <- as.data.frame(gsea_results_late)


library(ggplot2)

# Color gradient function for NES
color_gradient <- scale_fill_gradient2(
  low = "red",      # Low NES values (negative)
  mid = "white",    # Midpoint (zero)
  high = "blue",    # High NES values (positive)
  midpoint = 0,
  limits = c(min(gsea_results_late_df$NES), max(gsea_results_late_df$NES)),
  name = "NES"
)

ggplot(gsea_results_late_df, aes(x = reorder(Description, NES), y = NES, fill = NES)) +
     geom_bar(stat = "identity", show.legend = TRUE) +
     coord_flip() +
     color_gradient +
     labs(title = "Top GSEA Results for Late Timepoint",
          x = "Pathway",
          y = "Normalized Enrichment Score (NES)") +
     theme_minimal(base_size = 14) +
     theme(
         plot.title = element_text(hjust = 0.7, size = 20, face = "bold"),
         axis.title = element_text(size = 19),
         axis.text = element_text(size = 12),
         panel.grid.major = element_line(color = "grey90"),
         panel.grid.minor = element_blank(),
         legend.position = "bottom"
     )


# Metabolism Pathways


gsea_results_late_metab <- GSEA(
  geneList = lfc_vector_late, # Your ordered ranked gene list for Islet
  minGSSize = 5, # Minimum gene set size
  maxGSSize = 500, # Maximum gene set size
  pvalueCutoff = 1, # p-value cutoff
  eps = 0, # Boundary for calculating the p value
  seed = TRUE, # Set seed for reproducibility
  pAdjustMethod = "BH", # Benjamini-Hochberg correction
  TERM2GENE = mm_metabolism_df  # Use the new data frame
)

# Extract results for Islet
gsea_results_late_metab_df <- as.data.frame(gsea_results_late_metab)

# Color gradient function for NES
color_gradient <- scale_fill_gradient2(
  low = "red",      # Low NES values (negative)
  mid = "white",    # Midpoint (zero)
  high = "blue",    # High NES values (positive)
  midpoint = 0,
  limits = c(min(gsea_results_late_metab_df$NES), max(gsea_results_late_metab_df$NES)),
  name = "NES"
)

ggplot(gsea_results_late_metab_df, aes(x = reorder(Description, NES), y = NES, fill = NES)) +
     geom_bar(stat = "identity", show.legend = TRUE) +
     coord_flip() +
     color_gradient +
     labs(title = "Top GSEA Results for late Timepoint",
          x = "Pathway",
          y = "Normalized Enrichment Score (NES)") +
     theme_minimal(base_size = 14) +
     theme(
         plot.title = element_text(hjust = 0.7, size = 20, face = "bold"),
         axis.title = element_text(size = 19),
         axis.text = element_text(size = 12),
         panel.grid.major = element_line(color = "grey90"),
         panel.grid.minor = element_blank(),
         legend.position = "bottom"
     )

```


### Combining Dataframes from three timepoints

```{r GSEAFinalObject, echo=FALSE}

#CellType Enrichment
# Add prefixes to column names to identify the source of each data frame
names(gsea_results_early_df)[-1] <- paste0("early_", names(gsea_results_early_df)[-1])
names(gsea_results_intermediate_df)[-1] <- paste0("intermediate_", names(gsea_results_intermediate_df)[-1])
names(gsea_results_late_df)[-1] <- paste0("late_", names(gsea_results_late_df)[-1])

# Merge the three data frames based on the 'Description' column
combined_gsea_df <- Reduce(function(x, y) merge(x, y, by = "ID"), 
                           list(gsea_results_early_df, gsea_results_intermediate_df, gsea_results_late_df))

# View the combined data frame
head(combined_gsea_df)

# Save the combined data frame to a CSV file
write.csv(combined_gsea_df, "CellType_combined_gsea_results.csv", row.names = FALSE)

# Confirm the file location
cat("File saved as 'combined_gsea_results.csv' in the working directory.")

# Filter pathways where NES >= 1.5 or <= -1.5 AND pvalue < 0.05 for any condition
filtered_gsea_df <- combined_gsea_df[
  ((combined_gsea_df$early_NES >= 1.5 | combined_gsea_df$early_NES <= -1.5) & combined_gsea_df$early_pvalue < 0.05) |
  ((combined_gsea_df$intermediate_NES >= 1.5 | combined_gsea_df$intermediate_NES <= -1.5) & combined_gsea_df$intermediate_pvalue < 0.05) |
  ((combined_gsea_df$late_NES >= 1.5 | combined_gsea_df$late_NES <= -1.5) & combined_gsea_df$late_pvalue < 0.05),
]

# View the filtered data
head(filtered_gsea_df)

# Save the filtered data frame to a CSV file
write.csv(filtered_gsea_df, "Filtered_CellType_GSEA_results.csv", row.names = FALSE)

# Confirm the file location
cat("Filtered file saved as 'Filtered_CellType_GSEA_results.csv' in the working directory.")

# Metabolic and Immune Pathway Enrichment 

# Add prefixes to column names to identify the source of each data frame
names(gsea_results_early_metab_df)[-1] <- paste0("early_", names(gsea_results_early_metab_df)[-1])
names(gsea_results_intermediate_metab_df)[-1] <- paste0("intermediate_", names(gsea_results_intermediate_metab_df)[-1])
names(gsea_results_late_metab_df)[-1] <- paste0("late_", names(gsea_results_late_metab_df)[-1])

# Merge the three data frames based on the 'Description' column
combined_gsea_metab_df <- Reduce(function(x, y) merge(x, y, by = "ID"), 
                           list(gsea_results_early_metab_df, gsea_results_intermediate_metab_df, gsea_results_late_metab_df))

# View the combined data frame
head(combined_gsea_metab_df)

# Save the combined data frame to a CSV file
write.csv(combined_gsea_metab_df, "MetabolicPathways_combined_gsea_results.csv", row.names = FALSE)

# Subset pathways where NES >= 1.5 or <= -1.5 AND pvalue < 0.05 for any condition
filtered_gsea_metab_df <- combined_gsea_metab_df[
  ((combined_gsea_metab_df$early_NES >= 1.5 | combined_gsea_metab_df$early_NES <= -1.5) & combined_gsea_metab_df$early_pvalue < 0.05) |
  ((combined_gsea_metab_df$intermediate_NES >= 1.5 | combined_gsea_metab_df$intermediate_NES <= -1.5) & combined_gsea_metab_df$intermediate_pvalue < 0.05) |
  ((combined_gsea_metab_df$late_NES >= 1.5 | combined_gsea_metab_df$late_NES <= -1.5) & combined_gsea_metab_df$late_pvalue < 0.05),
]

# View the filtered data
head(filtered_gsea_metab_df)

# Save the filtered data to a CSV file
write.csv(filtered_gsea_metab_df, "Filtered_GSEA_metab_results.csv", row.names = FALSE)

# Confirm the file location
cat("Filtered file saved as 'Filtered_GSEA_metab_results.csv' in the working directory.")

```


### DotPlot-Immune Signalling Pathways
```{r DotPlotImmuneSignalling, echo=FALSE}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(tidyr)

# Reshape the data into long format for plotting
filtered_gsea_metab_long <- filtered_gsea_metab_df %>%
  select(ID, starts_with("early_"), starts_with("intermediate_"), starts_with("late_")) %>%
  pivot_longer(
    cols = -ID,
    names_to = c("timepoint", ".value"),
    names_pattern = "(early|intermediate|late)_(.+)"
  )

# Calculate bubble size as -log10(pvalue)
filtered_gsea_metab_long <- filtered_gsea_metab_long %>%
  mutate(bubble_size = -log10(pvalue))

Immune_pathways <- c(
  "KEGG_INSULIN_SIGNALING_PATHWAY",
  "HALLMARK_INTERFERON_ALPHA_RESPONSE",
  "HALLMARK_INTERFERON_GAMMA_RESPONSE",
  "KEGG_PPAR_SIGNALING_PATHWAY",
  "KEGG_PEROXISOME",
  "KEGG_ANTIGEN_PROCESSING_AND_PRESENTATION",
  "KEGG_LEUKOCYTE_TRANSENDOTHELIAL_MIGRATION",
  "KEGG_T_CELL_RECEPTOR_SIGNALING_PATHWAY",
  "KEGG_NATURAL_KILLER_CELL_MEDIATED_CYTOTOXICITY",
  "REACTOME_ALTERNATIVE_COMPLEMENT_ACTIVATION",
  "REACTOME_CD22_MEDIATED_BCR_REGULATION",
  "REACTOME_COSTIMULATION_BY_THE_CD28_FAMILY",
  "REACTOME_DAP12_SIGNALING",
  "REACTOME_FCGAMMA_RECEPTOR_FCGR_DEPENDENT_PHAGOCYTOSIS",
  "REACTOME_FCGR3A_MEDIATED_IL10_SYNTHESIS",
  "REACTOME_INTERLEUKIN_1_PROCESSING",
  "REACTOME_INTERLEUKIN_10_SIGNALING",
  "REACTOME_INTERLEUKIN_18_SIGNALING",
  "REACTOME_INTERLEUKIN_21_SIGNALING"
)


filtered_gsea_immune_top <- filtered_gsea_metab_long %>%
  filter(ID %in% Immune_pathways)

plot <- ggplot(filtered_gsea_immune_top, aes(x = timepoint, y = reorder(ID, NES))) +
  geom_point(aes(size = bubble_size, color = NES)) +
  scale_color_gradient2(low = "darkgreen", mid = "#F3E96B", high = "red", midpoint = 0) +  # NES color gradient
  scale_size(range = c(2, 10)) +  # Bubble size range
  theme_minimal() +
  labs(
    title = "Immune Signaling Pathways",
    x = "Time",
    y = "Pathway",
    size = "-log10(p-value)",
    color = "NES"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
    axis.text.y = element_text(size = 14),  # Adjust y-axis text size for readability
    axis.title.x = element_text(size = 18),  # Increase x-axis title size
    axis.title.y = element_text(size = 18),  # Increase y-axis title size
    legend.position = "right",
    plot.title = element_text(size = 22, face = "bold")  # Increase plot title size
  )
# Save the plot as a PNG file
ggsave("Immune_signaling_pathways_Scaffold.png", plot, width = 12, height = 10, dpi = 600)
```


### DotPlot-Metabolic Pathways
```{r DotPlotImmuneSignalling, echo=FALSE}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(tidyr)

# Reshape the data into long format for plotting
filtered_gsea_metab_long <- filtered_gsea_metab_df %>%
  select(ID, starts_with("early_"), starts_with("intermediate_"), starts_with("late_")) %>%
  pivot_longer(
    cols = -ID,
    names_to = c("timepoint", ".value"),
    names_pattern = "(early|intermediate|late)_(.+)"
  )

# Calculate bubble size as -log10(pvalue)
filtered_gsea_metab_long <- filtered_gsea_metab_long %>%
  mutate(bubble_size = -log10(pvalue))

metabolic_pathways <- c(
  "HALLMARK_CHOLESTEROL_HOMEOSTASIS",
  "HALLMARK_FATTY_ACID_METABOLISM",
  "KEGG_BIOSYNTHESIS_OF_UNSATURATED_FATTY_ACIDS",
  "KEGG_BUTANOATE_METABOLISM",
  "KEGG_CITRATE_CYCLE_TCA_CYCLE",
  "KEGG_FATTY_ACID_METABOLISM",
  "KEGG_GALACTOSE_METABOLISM",
  "KEGG_GLYCEROLIPID_METABOLISM",
  "KEGG_INSULIN_SIGNALING_PATHWAY",
  "KEGG_PROPANOATE_METABOLISM",
  "KEGG_PYRUVATE_METABOLISM",
  "KEGG_STARCH_AND_SUCROSE_METABOLISM",
  "KEGG_VALINE_LEUCINE_AND_ISOLEUCINE_DEGRADATION",
  "REACTOME_BETA_OXIDATION_OF_PRISTANOYL_COA",
  "REACTOME_BIOTIN_TRANSPORT_AND_METABOLISM",
  "REACTOME_CARNITINE_METABOLISM",
  "REACTOME_CHREBP_ACTIVATES_METABOLIC_GENE_EXPRESSION",
  "REACTOME_FATTY_ACYL_COA_BIOSYNTHESIS",
  "REACTOME_FRUCTOSE_METABOLISM",
  "REACTOME_GLUCONEOGENESIS",
  "REACTOME_GLUCOSE_METABOLISM",
  "REACTOME_GLYCOGEN_METABOLISM",
)

filtered_gsea_metab_top30 <- filtered_gsea_metab_long %>%
  filter(ID %in% metabolic_pathways)

plot2<-ggplot(filtered_gsea_metab_top30, aes(x = timepoint, y = reorder(ID, NES))) +
  geom_point(aes(size = bubble_size, color = NES)) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +  # NES color gradient
  scale_size(range = c(2, 10)) +  # Bubble size range
  theme_minimal() +
  labs(
    title = "Metabolic Pathways",
    x = "Time",
    y = "Pathway",
    size = "-log10(p-value)",
    color = "NES"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
    axis.text.y = element_text(size = 14),  # Adjust y-axis text size for readability
    axis.title.x = element_text(size = 18),  # Increase x-axis title size
    axis.title.y = element_text(size = 18),  # Increase y-axis title size
    legend.position = "right",
    plot.title = element_text(size = 22, face = "bold")  # Increase plot title size
  )

# Save the plot as a PNG file
ggsave("Metabolic_pathways_Scaffold.png", plot2, width = 12, height = 10, dpi = 600)
```



### DotPlot-CellType

```{r DotPlot, echo=FALSE}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(tidyr)

# Reshape the data into long format for plotting
filtered_gsea_celltype_long <- filtered_gsea_df  %>%
  select(ID, starts_with("early_"), starts_with("intermediate_"), starts_with("late_")) %>%
  pivot_longer(
    cols = -ID,
    names_to = c("timepoint", ".value"),
    names_pattern = "(early|intermediate|late)_(.+)"
  )

# Calculate bubble size as -log10(pvalue)
filtered_gsea_celltype_long <- filtered_gsea_celltype_long %>%
  mutate(bubble_size = -log10(p.adjust))

set.seed(123) # For reproducibility
Immune_pathways <- c(
  "HALLMARK_INTERFERON_ALPHA_RESPONSE",
  "HALLMARK_INTERFERON_GAMMA_RESPONSE",
  "KEGG_ANTIGEN_PROCESSING_AND_PRESENTATION",
  "KEGG_LEUKOCYTE_TRANSENDOTHELIAL_MIGRATION",
  "KEGG_NATURAL_KILLER_CELL_MEDIATED_CYTOTOXICITY",
  "KEGG_T_CELL_RECEPTOR_SIGNALING_PATHWAY",
  "KEGG_TYPE_I_DIABETES_MELLITUS",
  "REACTOME_ALTERNATIVE_COMPLEMENT_ACTIVATION",
  "REACTOME_CD22_MEDIATED_BCR_REGULATION",
  "REACTOME_CHEMOKINE_RECEPTORS_BIND_CHEMOKINES",
  "REACTOME_COMPLEMENT_CASCADE",
  "REACTOME_COSTIMULATION_BY_THE_CD28_FAMILY",
  "REACTOME_DAP12_SIGNALING",
  "REACTOME_DECTIN_2_FAMILY",
  "REACTOME_FCGAMMA_RECEPTOR_FCGR_DEPENDENT_PHAGOCYTOSIS",
  "REACTOME_FCGR_ACTIVATION",
  "REACTOME_FCGR3A_MEDIATED_IL10_SYNTHESIS",
  "REACTOME_IMMUNOREGULATORY_INTERACTIONS_BETWEEN_A_LYMPHOID_AND_A_NON_LYMPHOID_CELL",
  "REACTOME_INITIAL_TRIGGERING_OF_COMPLEMENT",
  "REACTOME_INTERLEUKIN_1_PROCESSING",
  "REACTOME_INTERLEUKIN_10_SIGNALING",
  "REACTOME_INTERLEUKIN_18_SIGNALING",
  "REACTOME_INTERLEUKIN_21_SIGNALING"
)


filtered_gsea_celltype_long_top20 <- filtered_gsea_celltype_long%>%
  filter(ID %in% Immune_pathways )

ggplot(filtered_gsea_celltype_long_top20, aes(x = timepoint, y = reorder(ID, NES))) +
  geom_point(aes(size = bubble_size, color = NES)) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +  # NES color gradient
  scale_size(range = c(2, 10)) +  # Bubble size range
  theme_minimal() +
  labs(
    title = "Top 20 GSEA CellType Enrichment Across Timepoints",
    x = "Timepoint",
    y = "Pathway",
    size = "-log10(p-value)",
    color = "NES"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 15),
    axis.text.y = element_text(size = 12),  # Adjust y-axis text size for readability
    axis.title.x = element_text(size = 14),  # Increase x-axis title size
    axis.title.y = element_text(size = 14),  # Increase y-axis title size
    legend.position = "right",
    plot.title = element_text(size = 16, face = "bold")  # Increase plot title size
  )

```

## Flow Cell Type Related Gene Analysis


### Early Stage Analysis

```{r CellTypeGenes}
# Required libraries
library(pheatmap)

# Filter Data for time
meta_combined_early <- meta_combined[meta_combined$Time == "Early", ]
# Ensure no duplicate sample names
combined_counts_early <- meta_combined_early[!duplicated(meta_combined_early$Samples), ]

# Filter combined_counts to keep only the samples in the subset metadata
combined_counts_early <- combined_counts[, colnames(combined_counts) %in% meta_combined_early$Samples]

combined_counts_early <- combined_counts_early[, meta_combined_early$Samples]  # Ensure Sample_IDs match column names in 


# List of genes to plot
genes_of_interest <- c("Lag3", "Pdcd1", "Mrc1", "Cd163", "Adgre1", 
                       "Cd3e", "Cd4", "Cd8a", "Cd86", "Il2ra", 
                       "Cd274", "Itgam", "Ptprc", "Itgax", "Ly6c1")


# Subset the combined counts for the genes of interest
filtered_counts_early <- combined_counts_early[rownames(combined_counts_early) %in% genes_of_interest, ]

dds_CellTypeGenes_early <- DESeqDataSetFromMatrix(countData = filtered_counts_early, colData = meta_combined_early, design = ~ Batch+Group)
dds_CellTypeGenes_early <- DESeq(dds_CellTypeGenes_early)
results_CellTypeGenes_early <- as.data.frame(results(dds_CellTypeGenes_early, contrast = c("Group", "Progressor", "Non-Progressor")))
results_Early$gene <- rownames(results_Early)

vsd <- varianceStabilizingTransformation(dds_CellTypeGenes_early, blind = FALSE)

vsd <- vst(dds_CellTypeGenes_early, blind = FALSE) # Estimates dispersion trend & stabilizes transformation
mat <- assay(vsd)
mat <- limma::removeBatchEffect(mat, vsd$Batch)
assay(vsd) <- mat
counts <- as.data.frame(assay(vsd)) # Summarized assay value, Update counts df


normalized_counts <- counts(dds_CellTypeGenes_early, normalized = TRUE)

# Calculate the z-scores for each gene (row-wise)
z_scores <- t(scale(t(log2(normalized_counts + 1))))  # Log-transform and scale

# Ensure metadata and counts are in the same order
# meta_combined_early <- meta_combined_early[match(colnames(z_scores), rownames(meta_combined_early)), ]



# Create a color palette for the groups
group_colors <- c("Progressor" = "#8A9A5B", "Non-Progressor" = "#FF2400")


# Ensure the metadata values exactly match the keys in group_colors
annotation <- data.frame(Group = as.character(meta_combined_early$Group))  # Ensure Group is a character vector
rownames(annotation) <- meta_combined_early$Samples

# Plot the heatmap
pheatmap(z_scores, 
         annotation_col = annotation, 
         annotation_colors = list(Group = group_colors), 
         scale = "none",  # Data is already z-scored
         cluster_cols = TRUE, 
         cluster_rows = TRUE, 
         color = colorRampPalette(c("blue", "white", "red"))(50), 
         show_colnames = FALSE, 
         main = "Z-Score Heatmap of Genes of Interest")

```